<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script type="module" src="../vl-multiselect.src.js"></script>
</head>
<body>

<test-fixture id="vl-multiselect-manual">
  <template>
    <vl-multiselect id="multiselect"></vl-multiselect>
  </template>
</test-fixture>

<test-fixture id="vl-multiselect-automatic">
  <template>
    <vl-multiselect data-vl-multiselect></vl-multiselect>
  </template>
</test-fixture>

<script>
  suite('vl-multiselect-manual', () => {
    let select, multiselect;

    setup((done) => {
      customElements.whenDefined('vl-multiselect').then(() => {
        multiselect = fixture('vl-multiselect-manual');
        select = multiselect._selectElement;
        done();
      });
    });

    const __dressMultiselect = () => {
      multiselect.dress({
        callbackFn: (select) => {
          return [
            {value: 'One', label: 'Label One', disabled: true},
            {value: 'Two', label: 'Label Two', selected: true},
            {value: 'Three', label: 'Label Three'},
          ];
        }
      });
    };

    test('js-vl-select div moet aanwezig zijn rond select voor CSS na manuele dress', () => {
      assert.isNull(select.closest('.js-vl-select'));
      __dressMultiselect();
      assert.isNotNull(select.closest('.js-vl-select'));
    });

    test('select heeft steeds data-vl-multiselect attribuut', () => {
      assert.isTrue(select.getAttributeNames().includes('data-vl-multiselect'));
    });

    test('select heeft steeds data-vl-select-dressed attribuut na manuele dress', (done) => {
      assert.isFalse(select.getAttributeNames().includes('data-vl-select-dressed'));
      __dressMultiselect();
      setTimeout(() => {
        assert.isTrue(select.getAttributeNames().includes('data-vl-select-dressed'));
        done();
      }, 0);
    });

    test('change events worden gepropageerd van vl-select naar vl-multiselect', (done) => {
      multiselect.addEventListener('change', (e) => {
        assert.isTrue(e.detail.values.includes("xyz"));
        done();
      });
      select.dispatchEvent(new CustomEvent('change', {"detail": {"value": "xyz"}}));
    });

    test('attributen worden gedelegeerd van vl-multiselect naar vl-select', () => {
      ['error', 'success', 'disabled'].forEach((attribuut) => {
        multiselect.setAttribute(attribuut, '');
        assert.isTrue(select.hasAttribute(attribuut));
        multiselect.removeAttribute(attribuut);
        assert.isFalse(select.hasAttribute(attribuut));
      });
    });

    test('attributen worden omgezet naar CSS class no manuele dress', (done) => {
      ['error', 'success', 'disabled'].forEach((attribuut) => {
        multiselect.setAttribute(attribuut, '');
        assert.isNull(select.closest('.js-vl-select'));
      });

      __dressMultiselect();

      setTimeout(() => {
        ['error', 'success', 'disabled'].forEach((attribuut) => {
          multiselect.setAttribute(attribuut, '');
          const wrapper = select.closest('.js-vl-select').parentNode;
          assert.isTrue(wrapper.classList.contains('vl-select--' + attribuut));
          multiselect.removeAttribute(attribuut);
          assert.isFalse(wrapper.classList.contains('vl-select--' + attribuut));
        });
        done();
      }, 0);
    });
  });

  suite('vl-multiselect-automatic', () => {

    let select, multiselect;

    setup((done) => {
      customElements.whenDefined('vl-multiselect').then(() => {
        multiselect = fixture('vl-multiselect-automatic');
        select = multiselect._selectElement;
        done();
      });
    });

    test('js-vl-select div moet aanwezig zijn rond select voor CSS', () => {
      const jsVlSelect = select.closest('.js-vl-select');
      assert.isNotNull(jsVlSelect);
    });

    test('select heeft steeds data-vl-multiselect attribuut', () => {
      assert.isTrue(select.getAttributeNames().includes('data-vl-multiselect'));
    });

    test('select heeft steeds data-vl-select-dressed attribuut', (done) => {
      setTimeout(() => {
        assert.isTrue(select.getAttributeNames().includes('data-vl-select-dressed'));
        done();
      }, 0);
    });

    test('change events worden gepropageerd van vl-select naar vl-multiselect', (done) => {
      multiselect.addEventListener('change', (e) => {
        assert.isTrue(e.detail.values.includes("xyz"));
        done();
      });
      select.dispatchEvent(new CustomEvent('change', {"detail": {"value": "xyz"}}));
    });

    test('attributen worden gedelegeerd van vl-multiselect naar vl-select', () => {
      ['error', 'success', 'disabled'].forEach((attribuut) => {
        multiselect.setAttribute(attribuut, '');
        assert.isTrue(select.hasAttribute(attribuut));
        multiselect.removeAttribute(attribuut);
        assert.isFalse(select.hasAttribute(attribuut));
      });
    });

    test('attributen worden omgezet naar CSS class', (done) => {
      setTimeout(() => {
        ['error', 'success', 'disabled'].forEach((attribuut) => {
          multiselect.setAttribute(attribuut, '');
          const wrapper = select.closest('.js-vl-select').parentNode;
          assert.isTrue(wrapper.classList.contains('vl-select--' + attribuut));
          multiselect.removeAttribute(attribuut);
          assert.isFalse(wrapper.classList.contains('vl-select--' + attribuut));
        });
        done();
      }, 0);
    });
  });
</script>
</body>
</html>